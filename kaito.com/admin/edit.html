<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Wedding Project - Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --secondary: #10b981;
            --danger: #ef4444;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --border: #e2e8f0;
            --radius: 12px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-header h2 {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sidebar-header p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .sidebar-nav {
            padding: 16px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer !important;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 12px;
            user-select: none;
            pointer-events: auto !important;
            position: relative;
            z-index: 10;
        }

        .nav-item * {
            pointer-events: none;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-tertiary);
            color: var(--primary);
            border-left: 3px solid var(--primary);
            padding-left: 13px;
        }

        .nav-item-icon {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
        }

        .topbar {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .breadcrumb a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .topbar-actions {
            display: flex;
            gap: 12px;
        }

        .container {
            padding: 32px;
            max-width: 1200px;
        }

        /* Section Content */
        .section-content {
            display: none;
        }

        .section-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            margin-bottom: 24px;
        }

        .section-header h1 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .section-header p {
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* Cards */
        .card {
            background: var(--bg-primary);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .card-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .card-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Form Groups */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        input[type="text"],
        input[type="url"],
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .help-text {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius);
            padding: 32px;
            text-align: center;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        .upload-area input[type="file"] {
            display: none;
        }

        .upload-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .upload-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .upload-text strong {
            color: var(--primary);
            cursor: pointer;
        }

        .preview-container {
            margin-top: 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .preview-item {
            position: relative;
            width: 120px;
            height: 120px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-save {
            position: fixed;
            bottom: 32px;
            right: 32px;
            padding: 16px 32px;
            font-size: 16px;
            box-shadow: 0 8px 24px rgba(14, 165, 233, 0.4);
            z-index: 999;
        }

        /* Alert */
        .alert {
            padding: 16px 20px;
            border-radius: 10px;
            margin-bottom: 24px;
            display: none;
            font-size: 14px;
            font-weight: 500;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid var(--secondary);
        }

        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid var(--danger);
        }

        /* Loading */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .main-content {
                margin-left: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <h2 id="page-title">‚ú® Edit Project</h2>
            <p id="page-subtitle">Loading...</p>
            <div style="margin-top: 12px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 12px; font-weight: 600; color: var(--primary); display: none;" id="template-badge">
                <span id="template-name-display"></span>
            </div>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-item active" data-section="basic" onclick="showSection('basic', this)">
                <span class="nav-item-icon">üìù</span>
                <span>Basic Information</span>
            </div>
            <div class="nav-item" data-section="venue" onclick="showSection('venue', this)">
                <span class="nav-item-icon">üìç</span>
                <span>Venue Details</span>
            </div>
            <div class="nav-item" data-section="photos" onclick="showSection('photos', this)">
                <span class="nav-item-icon">üì∏</span>
                <span>Photos</span>
            </div>
            <div class="nav-item" data-section="gallery" onclick="showSection('gallery', this)">
                <span class="nav-item-icon">üñºÔ∏è</span>
                <span>Gallery</span>
            </div>
            <div class="nav-item" data-section="settings" onclick="showSection('settings', this)">
                <span class="nav-item-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="topbar">
            <div class="breadcrumb">
                <a href="dashboard.html">Dashboard</a>
                <span>/</span>
                <span>Edit Project</span>
            </div>
            <div class="topbar-actions">
                <a href="dashboard.html" class="btn btn-secondary">‚Üê Back</a>
            </div>
        </div>

        <div class="container">
            <div id="alert" class="alert"></div>
            <!-- Template field (hidden, for data integrity) -->
            <input type="hidden" id="template_name">

            <!-- Section: Basic Information -->
            <div class="section-content active" id="section-basic">
                <div class="section-header">
                    <h1>Basic Information</h1>
                    <p>Enter the couple's details and wedding information</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Couple Information</h3>
                    </div>
                    <div class="form-group">
                        <label>Couple Names</label>
                        <input type="text" id="couple_names" placeholder="e.g., John & Jane">
                        <p class="help-text">Display names for the couple</p>
                    </div>
                    <div class="form-group">
                        <label>üí∞ Price</label>
                        <input type="number" id="price" placeholder="e.g., 500000" min="0" step="50000">
                        <p class="help-text">Order price in Rupiah (for analytics & revenue tracking)</p>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Groom Full Name</label>
                            <input type="text" id="groom_full_name" placeholder="e.g., John Smith">
                        </div>
                        <div class="form-group">
                            <label>Bride Full Name</label>
                            <input type="text" id="bride_full_name" placeholder="e.g., Jane Doe">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Wedding Title</label>
                        <input type="text" id="wedding_title" placeholder="e.g., The Wedding of">
                        <p class="help-text">Optional title shown above couple names</p>
                    </div>
                    <div class="form-group">
                        <label>Wedding Date</label>
                        <input type="text" id="wedding_date" placeholder="e.g., SATURDAY, 25 DECEMBER 2025">
                        <p class="help-text">Display format for the wedding date</p>
                    </div>
                    <div class="form-group">
                        <label>Thank You Message</label>
                        <textarea id="thank_you_message" placeholder="Thank you for your blessings..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Section: Venue -->
            <div class="section-content" id="section-venue">
                <div class="section-header">
                    <h1>Venue Details</h1>
                    <p>Wedding venue and timing information</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Venue Information</h3>
                    </div>
                    <div class="form-group">
                        <label>Venue Name</label>
                        <input type="text" id="venue_name" placeholder="e.g., Grand Ballroom Hotel">
                    </div>
                    <div class="form-group">
                        <label>Venue Address</label>
                        <textarea id="venue_address" placeholder="Full address of the venue"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Google Maps Embed Link</label>
                        <input type="url" id="venue_maps" placeholder="https://www.google.com/maps/embed/...">
                        <p class="help-text">Paste the embed link from Google Maps</p>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Ceremony Time</label>
                            <input type="text" id="ceremony_time" placeholder="e.g., 14:00 WIB">
                        </div>
                        <div class="form-group">
                            <label>Reception Time</label>
                            <input type="text" id="reception_time" placeholder="e.g., 18:00 WIB">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section: Photos -->
            <div class="section-content" id="section-photos">
                <div class="section-header">
                    <h1>Photos</h1>
                    <p>Upload couple photos and background images</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Background Image</h3>
                    </div>
                    <div class="upload-area" onclick="document.getElementById('background_image_file').click()">
                        <div class="upload-icon">‚òÅÔ∏è</div>
                        <div class="upload-text">
                            <strong>Click to upload</strong> or drag and drop<br>
                            PNG, JPG up to 10MB
                        </div>
                        <input type="file" id="background_image_file" accept="image/*">
                    </div>
                    <input type="text" id="background_image" style="display:none;">
                    <div id="background_image_preview" class="preview-container"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Groom Photo</h3>
                    </div>
                    <div class="upload-area" onclick="document.getElementById('groom_photo_file').click()">
                        <div class="upload-icon">üì∏</div>
                        <div class="upload-text">
                            <strong>Click to upload</strong> groom photo
                        </div>
                        <input type="file" id="groom_photo_file" accept="image/*">
                    </div>
                    <input type="text" id="groom_photo" style="display:none;">
                    <div id="groom_photo_preview" class="preview-container"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Bride Photo</h3>
                    </div>
                    <div class="upload-area" onclick="document.getElementById('bride_photo_file').click()">
                        <div class="upload-icon">üì∏</div>
                        <div class="upload-text">
                            <strong>Click to upload</strong> bride photo
                        </div>
                        <input type="file" id="bride_photo_file" accept="image/*">
                    </div>
                    <input type="text" id="bride_photo" style="display:none;">
                    <div id="bride_photo_preview" class="preview-container"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Hero/Cover Image</h3>
                    </div>
                    <div class="upload-area" onclick="document.getElementById('hero_image_file').click()">
                        <div class="upload-icon">üñºÔ∏è</div>
                        <div class="upload-text">
                            <strong>Click to upload</strong> hero image
                        </div>
                        <input type="file" id="hero_image_file" accept="image/*">
                    </div>
                    <input type="text" id="hero_image" style="display:none;">
                    <div id="hero_image_preview" class="preview-container"></div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Livestream Image</h3>
                    </div>
                    <div class="upload-area" onclick="document.getElementById('livestreaming_image_file').click()">
                        <div class="upload-icon">üì∫</div>
                        <div class="upload-text">
                            <strong>Click to upload</strong> livestream thumbnail
                        </div>
                        <input type="file" id="livestreaming_image_file" accept="image/*">
                    </div>
                    <input type="text" id="livestreaming_image" style="display:none;">
                    <div id="livestreaming_image_preview" class="preview-container"></div>
                </div>
            </div>

            <!-- Section: Gallery -->
            <div class="section-content" id="section-gallery">
                <div class="section-header">
                    <h1>Gallery Images</h1>
                    <p>Upload multiple images for the wedding gallery</p>
                </div>

                <div class="card">
                    <div class="upload-area" onclick="document.getElementById('gallery_images_files').click()">
                        <div class="upload-icon">üñºÔ∏è</div>
                        <div class="upload-text">
                            <strong>Click to upload</strong> or drag and drop<br>
                            Multiple images allowed
                        </div>
                        <input type="file" id="gallery_images_files" accept="image/*" multiple>
                    </div>
                    <div id="gallery_images_preview" class="preview-container"></div>
                </div>
            </div>

            <!-- Section: Settings -->
            <div class="section-content" id="section-settings">
                <div class="section-header">
                    <h1>Settings</h1>
                    <p>Privacy and publication settings</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Privacy Settings</h3>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="password_protected" style="width: auto;">
                            <span>Password Protection</span>
                        </label>
                        <p class="help-text">Require password to view the invitation</p>
                    </div>
                    <div class="form-group" id="password-field" style="display: none;">
                        <label>Invitation Password</label>
                        <input type="text" id="invitation_password" placeholder="Enter password">
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Publication</h3>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" id="is_published" style="width: auto;">
                            <span>Publish Invitation</span>
                        </label>
                        <p class="help-text">Make the invitation publicly accessible</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Statistics</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Total Views</label>
                            <input type="text" id="stat-views" readonly style="background: var(--bg-tertiary);">
                        </div>
                        <div class="form-group">
                            <label>Total RSVP</label>
                            <input type="text" id="stat-rsvp" readonly style="background: var(--bg-tertiary);">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <button class="btn btn-primary btn-save" onclick="saveData()">
            üíæ Save All Changes
        </button>
    </main>

    <script>
        const SUPABASE_URL = 'https://fnewihswvgtgzzsfaeis.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZuZXdpaHN3dmd0Z3p6c2ZhZWlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NzAwNzcsImV4cCI6MjA3OTU0NjA3N30.0OiXAfBDe5qGw8us5i9rjfNR75XdS0RlFojhy_RhKsY';

        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('‚úÖ Supabase client initialized');

        const urlParams = new URLSearchParams(window.location.search);
        let PROJECT_ID = urlParams.get('id');

        console.log('üîç Initial PROJECT_ID:', PROJECT_ID);
        console.log('üîç Type:', typeof PROJECT_ID);
        console.log('üîç Is null:', PROJECT_ID === null);
        console.log('üîç Is string:', typeof PROJECT_ID === 'string');

        // Decode and clean the ID
        if (PROJECT_ID) {
            PROJECT_ID = decodeURIComponent(PROJECT_ID).trim();
            console.log('‚úÖ Cleaned PROJECT_ID:', PROJECT_ID);
        }

        const REST_API_URL = `${SUPABASE_URL}/rest/v1/timeless_content`;
        const ORDERS_API_URL = `${SUPABASE_URL}/rest/v1/orders`;
        let currentProject = null;
        let isFromOrder = false;

        // Debug logging
        console.log('=== EDIT PAGE DEBUG ===');
        console.log('Full URL:', window.location.href);
        console.log('Search params:', window.location.search);
        console.log('Raw PROJECT_ID:', urlParams.get('id'));
        console.log('Decoded PROJECT_ID:', PROJECT_ID);
        console.log('Type of PROJECT_ID:', typeof PROJECT_ID);

        // Try to get from localStorage as fallback
        if (!PROJECT_ID) {
            const storedId = localStorage.getItem('editProjectId');
            if (storedId) {
                console.log('Using ID from localStorage:', storedId);
                PROJECT_ID = storedId;
            } else {
                console.error('‚ùå No PROJECT_ID found in URL or localStorage');
                // Show error and redirect to dashboard
                document.getElementById('error-container').style.display = 'flex';
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 3000);
            }
        } else {
            // Update localStorage with the current PROJECT_ID from URL
            console.log('Updating localStorage with PROJECT_ID:', PROJECT_ID);
            localStorage.setItem('editProjectId', PROJECT_ID);
        }

        // Section Navigation
        function showSection(sectionName, clickedElement) {
            console.log('üîµ showSection called!');
            console.log('  Section name:', sectionName);
            console.log('  Clicked element:', clickedElement);

            // Hide all sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            const targetSection = document.getElementById('section-' + sectionName);
            console.log('  Target section:', targetSection);
            if (targetSection) {
                targetSection.classList.add('active');
                console.log('  ‚úÖ Section activated:', sectionName);
            } else {
                console.error('  ‚ùå Section not found:', 'section-' + sectionName);
            }

            // Set active nav item
            if (clickedElement) {
                clickedElement.classList.add('active');
                console.log('  ‚úÖ Nav item activated');
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Initialize navigation event listeners
        function initNavigation() {
            console.log('Initializing navigation...');
            const navItems = document.querySelectorAll('.nav-item');
            console.log('Found nav items:', navItems.length);

            navItems.forEach((item, index) => {
                console.log(`Adding listener to nav item ${index}:`, item.getAttribute('data-section'));

                item.addEventListener('click', function(e) {
                    console.log('Nav item clicked!', this.getAttribute('data-section'));
                    e.preventDefault();
                    e.stopPropagation();

                    const sectionName = this.getAttribute('data-section');
                    showSection(sectionName, this);
                });

                // Add visual feedback on mousedown
                item.addEventListener('mousedown', function() {
                    console.log('Mousedown on nav item');
                    this.style.opacity = '0.7';
                });

                item.addEventListener('mouseup', function() {
                    this.style.opacity = '1';
                });
            });

            console.log('Navigation initialized successfully');
        }

        // Preview single image
        function previewImage(fileInputId, previewId) {
            const fileInput = document.getElementById(fileInputId);
            const preview = document.getElementById(previewId);

            if (fileInput.files && fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" style="width: 200px; height: 200px; object-fit: cover; border-radius: 8px; border: 2px solid #e0e0e0;">`;
                };
                reader.readAsDataURL(fileInput.files[0]);
            }
        }

        // Preview multiple gallery images
        function previewGalleryImages(fileInputId, previewId) {
            const fileInput = document.getElementById(fileInputId);
            const preview = document.getElementById(previewId);
            preview.innerHTML = '';

            if (fileInput.files && fileInput.files.length > 0) {
                Array.from(fileInput.files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.innerHTML = `<img src="${e.target.result}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #e0e0e0;">`;
                        preview.appendChild(div);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        // Convert image to base64 data URL
        async function convertImageToDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Upload gambar - convert to data URL
        async function uploadImage(file, fieldName) {
            return await convertImageToDataURL(file);
        }

        // Upload multiple gallery images
        async function uploadGalleryImages(files) {
            const uploadPromises = Array.from(files).map(async (file, index) => {
                return await convertImageToDataURL(file);
            });
            return await Promise.all(uploadPromises);
        }

        // Load data saat halaman dibuka
        async function loadData() {
            try {
                console.log('=== LOADING PROJECT DATA ===');
                console.log('Current URL:', window.location.href);
                console.log('URL Search:', window.location.search);
                console.log('PROJECT_ID:', PROJECT_ID);
                console.log('Type:', typeof PROJECT_ID);

                let data = null;

                // First try loading from timeless_content
                const contentUrl = `${REST_API_URL}?id=eq.${PROJECT_ID}&select=*`;
                console.log('Trying timeless_content:', contentUrl);

                let response = await fetch(contentUrl, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'apikey': SUPABASE_ANON_KEY
                    }
                });

                let results = await response.json();
                console.log('Timeless content results:', results);

                // If not found in timeless_content, try orders table
                if (!results || results.length === 0) {
                    console.log('Not found in timeless_content, trying orders table...');
                    const ordersUrl = `${ORDERS_API_URL}?id=eq.${PROJECT_ID}&select=*`;
                    console.log('Trying orders:', ordersUrl);

                    response = await fetch(ordersUrl, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'apikey': SUPABASE_ANON_KEY
                        }
                    });

                    results = await response.json();
                    console.log('Orders results:', results);

                    if (results && results.length > 0) {
                        isFromOrder = true;
                        console.log('‚úÖ Found in orders table!');
                    }
                }

                if (!results || results.length === 0) {
                    console.error('No results found in both tables for PROJECT_ID:', PROJECT_ID);
                    alert('‚ùå Project not found. Redirecting to dashboard...');
                    window.location.href = 'dashboard.html';
                    return;
                }

                data = results[0];
                currentProject = data;

                console.log('Project loaded successfully:', data);
                console.log('Couple names:', data.couple_names);
                console.log('Template name:', data.template_name);
                console.log('Is from order:', isFromOrder);

                // Ensure template_name has a default value
                if (!data.template_name) {
                    data.template_name = 'timeless'; // Default template
                    console.log('No template specified, using default: timeless');
                }

                // Update page subtitle with project info
                const templateLabel = data.template_name === 'elegant' ? 'Elegant' : 'Timeless';
                const templateEmoji = data.template_name === 'elegant' ? '‚ú®' : '‚è±Ô∏è';
                document.getElementById('page-subtitle').innerHTML = `
                    Editing: <strong>${data.couple_names || 'Unnamed'}</strong> - ${templateEmoji} ${templateLabel}
                    <span style="opacity: 0.5; font-size: 0.8em; margin-left: 10px;">(ID: ${PROJECT_ID})</span>
                `;

                // Show template badge in sidebar
                const templateBadge = document.getElementById('template-badge');
                const templateDisplay = document.getElementById('template-name-display');
                templateDisplay.textContent = 'üé® ' + templateLabel.toUpperCase() + ' TEMPLATE';
                templateBadge.style.display = 'block';

                // Set template_name hidden field BEFORE filling form
                const templateInput = document.getElementById('template_name');
                if (templateInput) {
                    templateInput.value = data.template_name;
                    console.log('Set template_name field to:', data.template_name);
                }

                // Fill form with data
                fillFormData(data);

            } catch (error) {
                console.error('Error loading project:', error);
                alert('‚ùå Error loading project. Please try again.');
                window.location.href = 'dashboard.html';
            }
        }

        // Safe element setter helper
        function safeSetValue(id, value, defaultValue = '') {
            const elem = document.getElementById(id);
            if (elem) {
                if (elem.type === 'checkbox') {
                    elem.checked = value || false;
                } else {
                    elem.value = value || defaultValue;
                }
                return true;
            } else {
                console.warn(`‚ö†Ô∏è Element not found: ${id}`);
                return false;
            }
        }

        function safeSetHTML(id, html) {
            const elem = document.getElementById(id);
            if (elem) {
                elem.innerHTML = html;
                return true;
            }
            return false;
        }

        function safeSetAttribute(id, attr, value) {
            const elem = document.getElementById(id);
            if (elem) {
                elem[attr] = value;
                return true;
            }
            return false;
        }

        // Helper function to fill form with data
        function fillFormData(data) {
            console.log('=== FILLING FORM DATA ===');
            console.log('Data:', data);

            if (!data) {
                console.error('No data provided to fillFormData');
                return;
            }

            try {
                // Template selection
                safeSetValue('template_name', data.template_name, 'timeless');

                // Update preview links with slug
                safeSetAttribute('preview-timeless', 'href', `../timeless/?slug=${data.slug}`);
                safeSetAttribute('preview-elegant', 'href', `../elegant/?slug=${data.slug}`);

                // Security & Privacy
                safeSetValue('password_protected', data.password_protected);
                safeSetValue('invitation_password', data.invitation_password);
                safeSetValue('is_published', data.is_published !== false);

                // Toggle password field visibility
                const passwordField = document.getElementById('password-field');
                if (passwordField) {
                    passwordField.style.display = data.password_protected ? 'block' : 'none';
                }

                // Analytics
                safeSetHTML('stat-views', data.views_count || 0);
                safeSetHTML('stat-rsvp', data.rsvp_count || 0);
                safeSetHTML('stat-last-viewed', data.last_viewed_at
                    ? new Date(data.last_viewed_at).toLocaleString()
                    : 'Never');

                // Basic Information
                safeSetValue('couple_names', data.couple_names);
                safeSetValue('price', data.price || 0);
                safeSetValue('groom_full_name', data.groom_full_name);
                safeSetValue('bride_full_name', data.bride_full_name);
                safeSetValue('wedding_title', data.wedding_title || data.hero_title);
                safeSetValue('wedding_date', data.wedding_date);

                // Venue Details
                safeSetValue('venue_name', data.venue_name || data.wedding_location);
                safeSetValue('venue_address', data.venue_address);
                safeSetValue('venue_maps', data.venue_maps);
                safeSetValue('ceremony_time', data.ceremony_time);
                safeSetValue('reception_time', data.reception_time);
                safeSetValue('thank_you_message', data.thank_you_message || data.thanks_text);

                // Photos - Set hidden inputs
                safeSetValue('background_image', data.background_section_1 || data.background_image);
                safeSetValue('groom_photo', data.background_section_2 || data.groom_photo);
                safeSetValue('bride_photo', data.background_section_3 || data.bride_photo);
                safeSetValue('hero_image', data.hero_background_image || data.hero_image);
                safeSetValue('livestreaming_image', data.livestreaming_image);

                // Show existing images
                const imageStyle = 'max-width: 200px; max-height: 200px; object-fit: cover; border-radius: 8px; border: 2px solid #e0e0e0;';

                if (data.background_section_1 || data.background_image) {
                    const bgImageSrc = data.background_section_1 || data.background_image;
                    safeSetHTML('background_image_preview', `<img src="${bgImageSrc}" style="${imageStyle}">`);
                }

                if (data.background_section_2 || data.groom_photo) {
                    const groomPhotoSrc = data.background_section_2 || data.groom_photo;
                    safeSetHTML('groom_photo_preview', `<img src="${groomPhotoSrc}" style="${imageStyle}">`);
                }

                if (data.background_section_3 || data.bride_photo) {
                    const bridePhotoSrc = data.background_section_3 || data.bride_photo;
                    safeSetHTML('bride_photo_preview', `<img src="${bridePhotoSrc}" style="${imageStyle}">`);
                }

                if (data.hero_background_image || data.hero_image) {
                    const heroImageSrc = data.hero_background_image || data.hero_image;
                    safeSetHTML('hero_image_preview', `<img src="${heroImageSrc}" style="${imageStyle}">`);
                }

                if (data.livestreaming_image) {
                    safeSetHTML('livestreaming_image_preview', `<img src="${data.livestreaming_image}" style="${imageStyle}">`);
                }

                // Gallery images
                if (data.gallery_images && data.gallery_images.length > 0) {
                    const galleryPreview = document.getElementById('gallery_images_preview');
                    if (galleryPreview) {
                        galleryPreview.innerHTML = '';
                        data.gallery_images.forEach(url => {
                            const div = document.createElement('div');
                            div.innerHTML = `<img src="${url}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #e0e0e0;">`;
                            galleryPreview.appendChild(div);
                        });
                    }
                }

                    console.log('‚úÖ Data berhasil dimuat!');
            } catch (error) {
                console.error('‚ùå Error in fillFormData:', error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                throw error; // Re-throw to be caught by loadData
            }
        }

        // Simpan semua data
        async function saveData() {
            const btn = event.target;
            btn.classList.add('loading');
            btn.textContent = 'üíæ Menyimpan...';

            try {
                // Upload images if new files are selected
                const backgroundImageFile = document.getElementById('background_image_file').files[0];
                const groomPhotoFile = document.getElementById('groom_photo_file').files[0];
                const bridePhotoFile = document.getElementById('bride_photo_file').files[0];
                const heroImageFile = document.getElementById('hero_image_file').files[0];
                const galleryImagesFiles = document.getElementById('gallery_images_files').files;

                let backgroundImageUrl = document.getElementById('background_image').value;
                let groomPhotoUrl = document.getElementById('groom_photo').value;
                let bridePhotoUrl = document.getElementById('bride_photo').value;
                let heroImageUrl = document.getElementById('hero_image').value;
                let livestreamingImageUrl = document.getElementById('livestreaming_image').value;
                let galleryImagesUrls = [];

                // Upload background image
                if (backgroundImageFile) {
                    btn.textContent = 'üì§ Mengupload background...';
                    backgroundImageUrl = await uploadImage(backgroundImageFile, 'background_image');
                }

                // Upload groom photo
                if (groomPhotoFile) {
                    btn.textContent = 'üì§ Mengupload foto pria...';
                    groomPhotoUrl = await uploadImage(groomPhotoFile, 'groom_photo');
                }

                // Upload bride photo
                if (bridePhotoFile) {
                    btn.textContent = 'üì§ Mengupload foto wanita...';
                    bridePhotoUrl = await uploadImage(bridePhotoFile, 'bride_photo');
                }

                // Upload hero image
                if (heroImageFile) {
                    btn.textContent = 'üì§ Mengupload hero image...';
                    heroImageUrl = await uploadImage(heroImageFile, 'hero_image');
                }

                // Upload livestreaming image
                const livestreamingImageFile = document.getElementById('livestreaming_image_file').files[0];
                if (livestreamingImageFile) {
                    btn.textContent = 'üì§ Mengupload livestreaming image...';
                    livestreamingImageUrl = await uploadImage(livestreamingImageFile, 'livestreaming_image');
                }

                // Upload gallery images
                if (galleryImagesFiles && galleryImagesFiles.length > 0) {
                    btn.textContent = `üì§ Mengupload ${galleryImagesFiles.length} gambar gallery...`;
                    galleryImagesUrls = await uploadGalleryImages(galleryImagesFiles);
                }

                btn.textContent = 'üíæ Menyimpan data...';

                // Use current project data
                let existingData = currentProject || {};
                let existingId = PROJECT_ID;

                // Build data object with only fields that exist in database schema
                const data = {
                    template_name: document.getElementById('template_name').value,
                    couple_names: document.getElementById('couple_names').value,
                    price: parseFloat(document.getElementById('price').value) || 0,
                    groom_full_name: document.getElementById('groom_full_name').value,
                    bride_full_name: document.getElementById('bride_full_name').value,
                    wedding_title: document.getElementById('wedding_title').value,
                    wedding_date: document.getElementById('wedding_date').value,
                    venue_name: document.getElementById('venue_name').value,
                    venue_address: document.getElementById('venue_address').value,
                    venue_maps: document.getElementById('venue_maps').value,
                    ceremony_time: document.getElementById('ceremony_time').value,
                    reception_time: document.getElementById('reception_time').value,
                    thank_you_message: document.getElementById('thank_you_message').value,
                    password_protected: document.getElementById('password_protected').checked,
                    invitation_password: document.getElementById('invitation_password').value,
                    is_published: document.getElementById('is_published').checked
                };

                // Only update image fields if new images were uploaded, otherwise preserve existing
                if (backgroundImageUrl) {
                    data.background_section_1 = backgroundImageUrl;
                } else if (existingData.background_section_1) {
                    data.background_section_1 = existingData.background_section_1;
                }

                if (groomPhotoUrl) {
                    data.background_section_2 = groomPhotoUrl;
                } else if (existingData.background_section_2) {
                    data.background_section_2 = existingData.background_section_2;
                }

                if (bridePhotoUrl) {
                    data.background_section_3 = bridePhotoUrl;
                } else if (existingData.background_section_3) {
                    data.background_section_3 = existingData.background_section_3;
                }

                if (heroImageUrl) {
                    data.hero_background_image = heroImageUrl;
                } else if (existingData.hero_background_image) {
                    data.hero_background_image = existingData.hero_background_image;
                }

                if (livestreamingImageUrl) {
                    data.livestreaming_image = livestreamingImageUrl;
                } else if (existingData.livestreaming_image) {
                    data.livestreaming_image = existingData.livestreaming_image;
                }

                // Add gallery images only if new ones were uploaded, otherwise preserve existing
                if (galleryImagesUrls.length > 0) {
                    data.gallery_images = galleryImagesUrls;
                } else if (existingData.gallery_images) {
                    data.gallery_images = existingData.gallery_images;
                } else {
                    data.gallery_images = [];
                }

                // Save using Supabase
                let saveResult;
                if (existingId) {
                    // Update existing record
                    console.log('Updating record with ID:', existingId);
                    console.log('Data to update:', data);

                    saveResult = await supabase
                        .from('timeless_content')
                        .update(data)
                        .eq('id', existingId);

                    console.log('Update result:', saveResult);
                } else {
                    // Insert new record
                    console.log('Inserting new record');
                    console.log('Data to insert:', data);

                    saveResult = await supabase
                        .from('timeless_content')
                        .insert(data);

                    console.log('Insert result:', saveResult);
                }

                if (saveResult.error) {
                    console.error('Supabase save error:', saveResult.error);
                    throw new Error(`Failed to save data: ${saveResult.error.message}`);
                }

                console.log('‚úÖ Data saved successfully!');
                showAlert('‚úÖ Data berhasil disimpan ke database! Refresh halaman timeless untuk melihat perubahan.', 'success');
                btn.textContent = '‚úÖ Berhasil Disimpan!';

                // Clear file inputs
                document.getElementById('background_image_file').value = '';
                document.getElementById('groom_photo_file').value = '';
                document.getElementById('bride_photo_file').value = '';
                document.getElementById('hero_image_file').value = '';
                document.getElementById('gallery_images_files').value = '';

                setTimeout(() => {
                    btn.textContent = 'üíæ Simpan Semua Perubahan';
                    btn.classList.remove('loading');
                    // Reload to show updated images
                    loadData();
                }, 2000);

            } catch (err) {
                console.error('Error saving:', err);
                showAlert('‚ùå Gagal menyimpan: ' + err.message, 'error');
                btn.textContent = 'üíæ Simpan Semua Perubahan';
                btn.classList.remove('loading');
            }
        }

        // Tampilkan alert
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert ' + type;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Load data saat halaman dibuka
        // Toggle password field visibility
        function initializePasswordToggle() {
            const checkbox = document.getElementById('password_protected');
            const passwordField = document.getElementById('password-field');

            if (checkbox && passwordField) {
                checkbox.addEventListener('change', function() {
                    passwordField.style.display = this.checked ? 'block' : 'none';
                });
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            console.log('Current URL:', window.location.href);
            console.log('PROJECT_ID:', PROJECT_ID);

            // Check if PROJECT_ID is provided
            if (!PROJECT_ID || PROJECT_ID === 'null' || PROJECT_ID === 'undefined') {
                const currentUrl = window.location.href;
                const storedId = localStorage.getItem('editProjectId');
                console.error('No valid project ID!');
                console.error('URL:', currentUrl);
                console.error('Stored ID:', storedId);

                // Show error message with more details
                document.body.innerHTML = `
                    <div style="max-width: 600px; margin: 100px auto; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center; font-family: system-ui;">
                        <h1 style="color: #ef4444; margin-bottom: 20px;">‚ùå Error</h1>
                        <p style="font-size: 18px; color: #333; margin-bottom: 20px;">
                            No project ID provided in URL
                        </p>
                        <p style="font-size: 14px; color: #666; margin-bottom: 30px;">
                            This page requires a project ID parameter.<br>
                            Example: <code>edit.html?id=123</code>
                        </p>
                        <a href="dashboard.html" style="display: inline-block; background: #f8fafc; color: white; padding: 14px 32px; border-radius: 8px; text-decoration: none; font-weight: 500;">
                            ‚Üê Back to Dashboard
                        </a>
                    </div>
                `;
                return;
            }

            // Initialize navigation
            initNavigation();

            loadData();
            initializePasswordToggle();

            // Add file input change listeners
            document.getElementById('background_image_file').addEventListener('change', () => previewImage('background_image_file', 'background_image_preview'));
            document.getElementById('groom_photo_file').addEventListener('change', () => previewImage('groom_photo_file', 'groom_photo_preview'));
            document.getElementById('bride_photo_file').addEventListener('change', () => previewImage('bride_photo_file', 'bride_photo_preview'));
            document.getElementById('hero_image_file').addEventListener('change', () => previewImage('hero_image_file', 'hero_image_preview'));
            document.getElementById('livestreaming_image_file').addEventListener('change', () => previewImage('livestreaming_image_file', 'livestreaming_image_preview'));
            document.getElementById('gallery_images_files').addEventListener('change', () => previewGalleryImages('gallery_images_files', 'gallery_images_preview'));
        });
    </script>
</body>
</html>
